#!/bin/sh
set -ouex pipefail

# Workaround until the zenity bug is fixed
UMU_DIR=/home/$USER/.local/share/umu/steamrt3
if [ ! -d "$UMU_DIR" ]; then
    URL=https://repo.steampowered.com/steamrt-images-sniper/snapshots/latest-container-runtime-public-beta/SteamLinuxRuntime_sniper.tar.xz
    TMP_DIR=$(mktemp -d /tmp/steamrt.XXXXXXXXXX) && mkdir -p $UMU_DIR

    curl -Lo $TMP_DIR/SteamRuntime.tar.xz $URL | zenity --title "Downloading Runtime" --progress --pulsate --no-cancel --auto-close 
    tar -xf $TMP_DIR/SteamRuntime.tar.xz -C $TMP_DIR

    mv $TMP_DIR/SteamLinuxRuntime*/* $UMU_DIR
    mv $UMU_DIR/_v2-entry-point $UMU_DIR/umu 
    rm -rf $TMP_DIR
fi

export WINEDLLOVERRIDES="${WINEDLLOVERRIDES:-OnlineFix64=n;SteamOverlay64=n;winmm=n,b;dnet=n;steam_api64=n;winhttp=n,b}"
export PROTONPATH="${PROTONPATH:-/usr/share/steam/compatibilitytools.d/Proton-System}"
export WINEPREFIX="${WINEPREFIX:-/home/$USER/.local/share/umu/prefix}"
export PROTON_VERB="${PROTON_VERB:-runinprefix}"

umu-run "$@"